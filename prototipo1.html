<html>
  <head>
    <meta charset="utf-8">
    <title>Rocket Hands VR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body style="margin: 0; background: black">
    <a-scene background="color: #000" vr-mode-ui="enabled: true">

      <!-- Camera e rig -->
      <a-entity id="rig" position="0 1.6 0">
        <a-camera wasd-controls="enabled: false"></a-camera>
        <!-- Mani razzo con controlli manuali -->
        <a-entity id="right-hand" hand-controls="hand: right" rocket-controls></a-entity>
        <a-entity id="left-hand" hand-controls="hand: left" rocket-controls></a-entity>
      </a-entity>

      <!-- Piattaforme -->
      <a-box position="0 2 -5" depth="4" height="0.5" width="4" color="#888"></a-box>
      <a-box position="3 6 -8" depth="4" height="0.5" width="4" color="#777"></a-box>
      <a-box position="-4 10 -12" depth="4" height="0.5" width="4" color="#666"></a-box>

      <!-- Luce ambientale -->
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>

      <!-- Debug info -->
      <a-text position="0 2.5 -2" value="Usa il joystick per attivare i razzi" color="white" align="center"></a-text>
      
      <!-- Debug visivo per i pulsanti -->
      <a-text id="debug-text" position="0 2 -1" value="Nessun pulsante premuto" color="yellow" align="center" scale="0.8 0.8 0.8"></a-text>

      <!-- Script per il movimento a razzo -->
      <script>
        AFRAME.registerComponent('rocket-controls', {
          init: function () {
            // Inizializzazione del componente
            this.isRocketActive = false;
            this.hand = this.el;
            this.rig = document.querySelector('#rig');
            this.threshold = 0.3; // Soglia minima per attivare il razzo
          },

          tick: function () {
            const hand = this.el;
            const rig = document.querySelector('#rig');
            
            // Verifica se il controller è disponibile
            if (!hand.components['hand-controls']) return;
            
            const controller = hand.components['hand-controls'].controller;
            if (!controller) return;

            // Debug: mostra i valori del joystick nella console
            if (controller.axes && controller.axes.length >= 2) {
              const joystickX = controller.axes[0];
              const joystickY = controller.axes[1];
              
              // Mostra i valori solo se il joystick è mosso
              if (Math.abs(joystickX) > 0.1 || Math.abs(joystickY) > 0.1) {
                console.log(`Joystick ${hand.getAttribute('hand-controls').hand}: X=${joystickX.toFixed(2)}, Y=${joystickY.toFixed(2)}`);
              }
            }

            // Controllo del joystick per attivare il razzo
            let joystickActive = false;
            if (controller.axes && controller.axes.length >= 2) {
              const joystickX = controller.axes[0];
              const joystickY = controller.axes[1];
              
              // Calcola la magnitudine del movimento del joystick
              const magnitude = Math.sqrt(joystickX * joystickX + joystickY * joystickY);
              
              // Attiva il razzo se il joystick è spostato oltre la soglia
              if (magnitude > this.threshold) {
                joystickActive = true;
                
                if (!this.isRocketActive) {
                  this.isRocketActive = true;
                  console.log(`Razzo attivato con joystick ${hand.getAttribute('hand-controls').hand}!`);
                }
                
                // Calcola direzione della spinta basata sul joystick
                const direction = new THREE.Vector3();
                hand.object3D.getWorldDirection(direction);
                
                // Aggiungi componente laterale basato sul joystick
                const rightVector = new THREE.Vector3();
                hand.object3D.getWorldDirection(rightVector);
                rightVector.cross(direction, new THREE.Vector3(0, 1, 0)).normalize();
                
                // Combina direzione avanti con movimento laterale del joystick
                direction.add(rightVector.multiplyScalar(joystickX * 0.5));
                
                // Aggiungi componente verticale basato sul joystick Y
                direction.y += joystickY * 0.3;
                
                direction.normalize();
                direction.multiplyScalar(-0.08 * magnitude); // Spinta proporzionale al movimento
                
                // Applica la spinta al rig
                rig.object3D.position.add(direction);
              }
            }
            
            // Reset dello stato del razzo
            if (!joystickActive) {
              this.isRocketActive = false;
            }
          }
        });

        // Componente per debug visivo dei pulsanti
        AFRAME.registerComponent('button-debug', {
          init: function () {
            this.debugText = document.querySelector('#debug-text');
            this.lastButtonState = {};
          },
          
          tick: function () {
            const controllers = document.querySelectorAll('[hand-controls]');
            let debugMessage = '';
            let buttonPressed = false;
            
            controllers.forEach(controller => {
              const handControls = controller.components['hand-controls'];
              if (handControls && handControls.controller) {
                const gamepad = handControls.controller;
                const hand = handControls.data.hand;
                
                // Debug pulsanti
                if (gamepad.buttons) {
                  gamepad.buttons.forEach((button, index) => {
                    if (button.pressed) {
                      buttonPressed = true;
                      const buttonName = this.getButtonName(index);
                      debugMessage += `${hand.toUpperCase()}: ${buttonName} | `;
                      console.log(`Pulsante ${index} (${buttonName}) premuto sulla mano ${hand}`);
                    }
                  });
                }
                
                // Debug joystick
                if (gamepad.axes && gamepad.axes.length >= 2) {
                  const joystickX = gamepad.axes[0];
                  const joystickY = gamepad.axes[1];
                  const magnitude = Math.sqrt(joystickX * joystickX + joystickY * joystickY);
                  
                  if (magnitude > 0.1) {
                    debugMessage += `${hand.toUpperCase()}: Joystick X=${joystickX.toFixed(2)}, Y=${joystickY.toFixed(2)} | `;
                  }
                }
              }
            });
            
            // Aggiorna il testo di debug
            if (buttonPressed || debugMessage !== '') {
              this.debugText.setAttribute('value', debugMessage || 'Nessun pulsante premuto');
              this.debugText.setAttribute('color', 'lime');
            } else {
              this.debugText.setAttribute('value', 'Nessun pulsante premuto');
              this.debugText.setAttribute('color', 'yellow');
            }
          },
          
          getButtonName: function(index) {
            const buttonNames = {
              0: 'Trigger',
              1: 'Grip',
              2: 'A/X',
              3: 'B/Y',
              4: 'Thumbstick',
              5: 'Menu'
            };
            return buttonNames[index] || `Pulsante ${index}`;
          }
        });

        // Aggiungi il debug alla scena
        document.addEventListener('DOMContentLoaded', function() {
          const scene = document.querySelector('a-scene');
          scene.setAttribute('button-debug', '');
        });
      </script>

    </a-scene>
  </body>
</html>
