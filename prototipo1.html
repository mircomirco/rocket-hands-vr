<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Rocket Hands VR - Piattaforme e Volo</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
  </head>
  <body>
    <a-scene vr-mode-ui="enabled: true" physics="gravity: -9.8; debug: true">
      <!-- Testo UI per mostrare il bottone premuto -->
      <a-text id="btnLabel" value="Usa A e X per volare!" position="0 4 -1" align="center" color="#FFF" scale="2 2 2"></a-text>

      <!-- Testo per lo stato dei razzi -->
      <a-text id="rocketStatus" value="Razzi: SPENTI" position="0 3.5 -1" align="center" color="#FF6B6B" scale="1.5 1.5 1.5"></a-text>

      <!-- Debug info -->
      <a-text id="debugInfo" value="Debug: Inizializzazione..." position="0 3 -1" align="center" color="#FFFF00" scale="1 1 1"></a-text>

      <!-- Controller sinistro -->
      <a-entity id="leftCtl"
                meta-touch-controls="hand: left"
                rocket-controller="hand: left"></a-entity>
      <!-- Controller destro -->
      <a-entity id="rightCtl"
                meta-touch-controls="hand: right"
                rocket-controller="hand: right"></a-entity>

      <!-- Piattaforma di partenza (base) -->
      <a-box position="0 0.5 0" 
             width="8" height="1" depth="8" 
             color="#4CAF50" 
             static-body></a-box>

      <!-- Piattaforma sinistra (livello medio) -->
      <a-box position="-6 3 0" 
             width="6" height="1" depth="6" 
             color="#2196F3" 
             static-body></a-box>

      <!-- Piattaforma destra (livello alto) -->
      <a-box position="6 5.5 0" 
             width="6" height="1" depth="6" 
             color="#FF9800" 
             static-body></a-box>

      <!-- Particelle per i razzi -->
      <a-entity id="leftRocketParticles" position="0 0 0" visible="false">
        <a-sphere position="0 0 0" radius="0.1" color="#FF4444" animation="property: scale; to: 2 2 2; dur: 200; easing: easeOutQuad; loop: true"></a-sphere>
        <a-sphere position="0 0.2 0" radius="0.05" color="#FF6666" animation="property: scale; to: 1.5 1.5 1.5; dur: 150; easing: easeOutQuad; loop: true"></a-sphere>
      </a-entity>

      <a-entity id="rightRocketParticles" position="0 0 0" visible="false">
        <a-sphere position="0 0 0" radius="0.1" color="#FF4444" animation="property: scale; to: 2 2 2; dur: 200; easing: easeOutQuad; loop: true"></a-sphere>
        <a-sphere position="0 0.2 0" radius="0.05" color="#FF6666" animation="property: scale; to: 1.5 1.5 1.5; dur: 150; easing: easeOutQuad; loop: true"></a-sphere>
      </a-entity>

      <!-- Luci per illuminare le piattaforme -->
      <a-light type="ambient" color="#404040"></a-light>
      <a-light type="directional" position="0 10 5" color="#FFFFFF" intensity="0.8"></a-light>

      <!-- Cielo -->
      <a-sky color="#87CEEB"></a-sky>
    </a-scene>

    <script>
      // Componente per gestire i controller e i razzi
      AFRAME.registerComponent('rocket-controller', {
        schema: {
          hand: {type: 'string', default: 'right'}
        },
        
        init: function () {
          const el = this.el;
          const hand = this.data.hand;
          const debugInfo = document.getElementById('debugInfo');
          const rocketStatus = document.getElementById('rocketStatus');
          
          // Stato dei razzi
          this.rocketActive = false;
          this.thrustForce = 0.1;
          this.isInitialized = false;
          
          // Particelle del razzo corrispondente
          this.rocketParticles = document.getElementById(hand === 'left' ? 'leftRocketParticles' : 'rightRocketParticles');
          
          // Pulsanti da monitorare (A per mano destra, X per mano sinistra)
          const targetButton = hand === 'right' ? 'abutton' : 'xbutton';
          
          debugInfo.setAttribute('value', `Debug: Controller ${hand} inizializzato`);
          
          // Eventi per attivazione/disattivazione razzi
          el.addEventListener(targetButton + 'down', (event) => {
            console.log(`${targetButton} premuto su ${hand}`);
            debugInfo.setAttribute('value', `Debug: ${targetButton} premuto su ${hand}`);
            this.activateRocket();
          });
          
          el.addEventListener(targetButton + 'up', (event) => {
            console.log(`${targetButton} rilasciato su ${hand}`);
            debugInfo.setAttribute('value', `Debug: ${targetButton} rilasciato su ${hand}`);
            this.deactivateRocket();
          });
          
          // Eventi aggiuntivi per debug
          el.addEventListener('controllerconnected', () => {
            console.log(`Controller ${hand} connesso`);
            debugInfo.setAttribute('value', `Debug: Controller ${hand} connesso`);
            this.isInitialized = true;
          });
          
          // Funzione per attivare il razzo
          this.activateRocket = () => {
            this.rocketActive = true;
            this.rocketParticles.setAttribute('visible', true);
            rocketStatus.setAttribute('value', `Razzi: ATTIVI (${hand.toUpperCase()})`);
            rocketStatus.setAttribute('color', '#4CAF50');
            
            // Applica forza verso l'alto alla camera
            this.applyThrust();
          };
          
          // Funzione per disattivare il razzo
          this.deactivateRocket = () => {
            this.rocketActive = false;
            this.rocketParticles.setAttribute('visible', false);
            rocketStatus.setAttribute('value', 'Razzi: SPENTI');
            rocketStatus.setAttribute('color', '#FF6B6B');
          };
          
          // Funzione per applicare la spinta
          this.applyThrust = () => {
            if (this.rocketActive) {
              const camera = document.querySelector('[camera]');
              if (camera) {
                const currentPos = camera.getAttribute('position');
                const newY = currentPos.y + this.thrustForce;
                camera.setAttribute('position', {x: currentPos.x, y: newY, z: currentPos.z});
                
                debugInfo.setAttribute('value', `Debug: Volo attivo - Y: ${newY.toFixed(2)}`);
              }
              
              // Continua ad applicare la spinta finché il razzo è attivo
              if (this.rocketActive) {
                setTimeout(() => this.applyThrust(), 50);
              }
            }
          };
          
          // Aggiorna la posizione delle particelle del razzo
          this.tick = () => {
            if (this.rocketActive) {
              const camera = document.querySelector('[camera]');
              if (camera) {
                const cameraPos = camera.getAttribute('position');
                const handPos = el.getAttribute('position');
                
                // Posiziona le particelle vicino alla mano del controller
                this.rocketParticles.setAttribute('position', {
                  x: handPos.x,
                  y: handPos.y - 0.2,
                  z: handPos.z
                });
              }
            }
          };
        }
      });

      // Componente per il debug dei pulsanti (mantenuto per riferimento)
      AFRAME.registerComponent('button-listener', {
        init: function () {
          const el = this.el;
          const lbl = document.getElementById('btnLabel');
          const buttons = [
            'trigger', 'grip', 'thumbstick', 'abutton', 'bbutton',
            'xbutton', 'ybutton', 'surface'
          ];
          buttons.forEach(btn => {
            ['down','up','touchstart','touchend'].forEach(evtType => {
              const evtName = btn + evtType;
              el.addEventListener(evtName, e => {
                lbl.setAttribute('value', `${evtName} su ${el.getAttribute('meta-touch-controls').hand}`);
              });
            });
          });
        }
      });

      // Debug globale per verificare che tutto funzioni
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM caricato');
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.setAttribute('value', 'Debug: DOM caricato, in attesa dei controller...');
      });
    </script>
  </body>
</html>